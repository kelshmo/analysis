###Draft

---
title: "Differential Expression - Tissue"
author: "Kelsey Montgomery, Gabriel Hoffman, Thaneer Perumal"
date: "`r date()`"
output: html_document
---

```{r knit2synapse, eval=FALSE}
library(synapser)
library(knit2synapse)

synLogin()

knit2synapse::createAndKnitToFolderEntity(file = "./cmc-rnaseq-de/Differential-Expression.Rmd",
                                 parentId ="syn21887806",
                                 folderName = "Differential Expression - Tissue")
```

```{r libs, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
## Load required libraries
library(CovariateAnalysis) # get the package from devtools::install_github('th1vairam/CovariateAnalysis@dev')
library(data.table)
library(tidyr)
library(plyr)
library(dplyr)
library(stringr)
library(R.utils)
library(ggplot2)
library(limma)
library(psych)
library(lme4)
library(biomaRt)
library(variancePartition) #1.17.9
library(edgeR)
library(synapser)
library(knitr)
library(githubr) # get the package from devtools::install_github('brian-bot/githubr')

synLogin()

library(foreach)
library(future)
library(BiocParallel)

# See dream documentation to customize parallel processing       http://bioconductor.org/packages/release/bioc/vignettes/variancePartition/inst/doc/dream.html#parallel-processing
param = SnowParam((availableCores()-2)/2, "SOCK", progressbar=TRUE)

register(param)

options(xtable.type="html")

knitr::opts_chunk$set(
  echo=FALSE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  cache = TRUE)
```

```{r synapse.parameters, include=FALSE, cache=TRUE}
parentId = 'syn21887806';
activityName = 'Differential Expression';
activityDescription = 'Differential Expression - Tissue';

thisFileName <- 'Differential-Expression_Tissue.Rmd'

# Github link
thisRepo <- getRepo(repository = "kelshmo/analysis", ref="branch", refName='differential-expression')
thisFile <- getPermlink(repository = thisRepo, repositoryPath=paste0('cmc-rnaseq-de/',thisFileName))
```

### Data download
#### Obtain filtered and CQN normalized counts
```{r download.data, cache=TRUE}
downloadFile <- function(id){
  fread(synGet(id)$path, data.table = F, header = T)
}

# Download CQN counts
CQN_ID = "syn21888972"
ALL_USED_IDs = c(CQN_ID)
CQN.GENE_EXPRESSION = downloadFile(CQN_ID) %>% 
  tibble::column_to_rownames(var = "ensembl_gene_id") %>% 
  data.matrix()
  
# Download filtered counts
COUNTS_ID = "syn21888969"
ALL_USED_IDs = c(ALL_USED_IDs, COUNTS_ID)
NEW.COUNTS = downloadFile(COUNTS_ID) %>% 
  tibble::column_to_rownames(var = "ensembl_gene_id")
  
# Get covariates
COVAR_ID = "syn21888968"
ALL_USED_IDs = c(ALL_USED_IDs, COVAR_ID)
COVARIATES = downloadFile(COVAR_ID) %>% 
  tibble::column_to_rownames(var = "SampleID")

# Set variable class
FactorCovariates <- c("Individual_ID", "Reported_Gender", "Dx.Tissue", "IsolationBatch")
COVARIATES[,FactorCovariates] = lapply(COVARIATES[,FactorCovariates], factor)

ContCovariates <- c("ageOfDeath", "PMI", "RIN", "MappedReads", "IntragenicRate", "IntronicRate", "IntergenicRate",
                    "GenesDetected", "ExpProfEfficiency", "rRNARate", "TotalReads","AlignmentRate", 
                    "EV.1", "EV.2", "EV.3", "EV.4", "EV.5")
COVARIATES[,ContCovariates] = lapply(COVARIATES[,ContCovariates], function(x){
  x = as.numeric(as.character(gsub('[\\,\\%]','',x)))
})

# Set covariates to adjust for from model selection
adjust.covars <- c("Dx.Tissue", "RIN", "rRNARate", "IntragenicRate")
```

### Normalisation - Tissue
1. Tissue is chosen as the primary variable of interest (i.e., covariate adjustments is conditioned on diagnosis and reported gender)
2. Individual_ID is chosen as random effect
```{r iterative.normalisation-tissue, results='asis'}
###we might not need this adjustment
COVARIATES <- tidyr::separate(COVARIATES, Dx.Tissue.Gender, c("Dx", "Tissue", "Reported_Gender")) %>% 
  dplyr::mutate(Dx = factor(Dx, levels = c("SCZ", "Control", "Other")),
                Tissue = factor(Tissue), 
                Reported_Gender = factor(Reported_Gender))
adjust.covars[1] <- "Dx"
adjust.covars <- c(adjust.covars, "Tissue", "Reported_Gender")
writeLines(paste('Using following covariates in the model:',
                 paste(adjust.covars, collapse=', '),
                 'as fixed effects and Individual_ID is chosen as random effect'))
# Post adjusted formula
random_effect <- "Individual_ID"
formula <- glue::glue("~ ", glue::glue_collapse(adjust.covars, sep = " + ")) %>% 
  glue::glue(" + (1|{random_effect})")
# Estimate voom weights with DREAM
geneExpr = DGEList(NEW.COUNTS)
geneExpr = edgeR::calcNormFactors(geneExpr)
VOOM.GENE_EXPRESSION = variancePartition::voomWithDreamWeights(counts = geneExpr, 
                                                               formula = formula,
                                                               data = COVARIATES,
                                                               save.plot = TRUE)
plot(VOOM.GENE_EXPRESSION)
# Fit linear model using new weights and new design
VOOM.GENE_EXPRESSION$E = CQN.GENE_EXPRESSION$E
Tissue_ADJUSTED.FIT = variancePartition::dream(exprObj = VOOM.GENE_EXPRESSION, 
                                        formula = formula,
                                        data = COVARIATES,
                                        computeResiduals = TRUE)
col_type <- dplyr::select(COVARIATES, c(adjust.covars, "Individual_ID")) %>%
  dplyr::summarise_all(class) %>% 
  tidyr::gather(variable, class)
# Model categorical variables as random to report variance fractions
formula_for_variance_fractions = sapply(1:length(col_type$class), function(i){
  switch(col_type$class[i], 
    "factor" = paste0('(1|', col_type$variable[i], ')'),
    "numeric" = col_type$variable[i])
  })
formula_for_variance_fractions <- glue::glue("~ ", glue::glue_collapse(formula_for_variance_fractions, sep = " + "))
violin_plot <- variancePartition::fitExtractVarPartModel(VOOM.GENE_EXPRESSION,
                                                         formula = formula_for_variance_fractions,
                                                         data = COVARIATES)
plotVarPart(sortCols(violin_plot))
# Residuals after normalisation
Tissue_RESIDUAL.GENE_EXPRESSION = residuals(Tissue_ADJUSTED.FIT, CQN.GENE_EXPRESSION$E)
# Find PC of residual gene expression and significant covariates that are highly correlated with PCs
residualSigCovars = runPCAandPlotCorrelations(Tissue_RESIDUAL.GENE_EXPRESSION, COVARIATES,
                                              'adjusted design(voom-normalized)',
                                              isKeyPlot=TRUE)
```

### Sanity check
```{r residualSigCovars.manual-tissue, fig.width=12, fig.height=8}
residualSigCovars[["PC_res"]][[2]]$plotData
```

### Differential expression analysis (ACC - DLPFC)
Genes that are differentially expressed at an FDR <= 0.05 are:
```{r set-formula-tissue}
formula <- glue::glue("~ 0 + ", glue::glue_collapse(adjust.covars, sep = " + ")) %>% 
  glue::glue(" + (1|{random_effect})")
```

`r formula`

```{r diffExp-tissue, fig.height=10, fig.width=15}
L1 = variancePartition::getContrast(exprObj = VOOM.GENE_EXPRESSION, 
                                   formula = formula, 
                                   data = COVARIATES, 
                                   coefficient = c("TissueDLPFC"))
L2 = variancePartition::getContrast(exprObj = VOOM.GENE_EXPRESSION, 
                                   formula = formula, 
                                   data = COVARIATES, 
                                   coefficient = c("DxSCZ", "DxControl"))
L3 = variancePartition::getContrast(exprObj = VOOM.GENE_EXPRESSION, 
                                   formula = formula, 
                                   data = COVARIATES, 
                                   coefficient = c("Reported_GenderMale"))
L = cbind(L1, L2, L3)
contrast <- c(glue::glue_collapse(names(L1[L1 != 0]), "-"), 
              glue::glue_collapse(names(L2[L2 != 0]), "-"),
              glue::glue_collapse(names(L3[L3 != 0]), "-")
)
# Visualize contrast matrix
plotContrasts(L) 
# Fit contrast
FIT.CONTR = variancePartition::dream(exprObj = VOOM.GENE_EXPRESSION,
                                     formula = formula,
                                     data = COVARIATES,
                                     L = L)
# Get differential expression
DE_3 = lapply(glue::glue("L{1:3}"), function(i, FIT){
  topTable(FIT, coef=i, number = Inf) %>%
    rownameToFirstColumn('gene_id') %>% 
    left_join(backgroundGenes)
}, FIT.CONTR) 
names(DE_3) <- contrast
DE_3 = DE_3%>% 
  rbindlist(idcol = 'Comparison') %>%
  dplyr::mutate(Comparison = gsub('Dx.Tissue','',Comparison),
                Direction = logFC/abs(logFC),
                Direction = factor(Direction, c(-1,1), c('-1' = 'DOWN', '1' = 'UP')),
                Direction = as.character(Direction)) %>% 
  dplyr::mutate(Comparison = ifelse(Comparison %in% "Reported_GenderMale", "Female-Male", Comparison),
                Comparison = ifelse(Comparison %in% "DxSCZ-DxControl", "SCZ-Control", Comparison),
                Comparison = ifelse(Comparison %in% "TissueDLPFC", "ACC-DLPFC", Comparison)) %>% 
  left_join(Ensemble2HGNC) %>%
  left_join(gene_lengths %>% rownameToFirstColumn('gene_id'))
DE_3$Direction[DE_3$adj.P.Val > 0.05 | abs(DE_3$logFC) < log2(1.2)] = 'NONE'
tmp = DE_3 %>%
  dplyr::filter(adj.P.Val <= 0.05) %>%
  dplyr::select(ensembl_gene_id, Comparison) %>%
  group_by(Comparison) %>%
  dplyr::summarise(FDR_0_05 = length(unique(ensembl_gene_id)))
tmp1 = DE_3 %>%
  dplyr::filter(adj.P.Val <= 0.05, abs(logFC) >= log2(1.2)) %>%
  dplyr::select(ensembl_gene_id, Comparison) %>%
  group_by(Comparison) %>%
  dplyr::summarise(FDR_0_05_FC_1.2 = length(unique(ensembl_gene_id)))
kable(full_join(tmp,tmp1))
p = ggplot(DE_3, aes(y = -log10(adj.P.Val), x = logFC, color = Direction)) + geom_point() + xlim(c(-1,1))
p = p + scale_color_manual(values = c('green','grey','red')) + theme_bw() %+replace% theme(legend.position = 'top')
p = p + facet_grid(Comparison~., scales = 'fixed')
p
```




### Residual calculation
Calculate weighted residuals and add back "Dx.Tissue" to the residuals
```{r varsToAddBack}
# Add variable of interest back to the residuals
varsToAddIn = grep("Dx.Tissue", colnames(ADJUSTED.FIT$design), value = T)
RESIDUAL.GENE_EXPRESSION = RESIDUAL.GENE_EXPRESSION +
  ADJUSTED.FIT$coefficients[,varsToAddIn] %*% t(ADJUSTED.FIT$design[,varsToAddIn])
```

### Coexpression of residual expression 
```{r coexp2, cache=FALSE, fig.height=5, fig.width=5}
cr = cor(t(RESIDUAL.GENE_EXPRESSION))
hist(cr, main = 'Distribution of correlation between genes', xlab = 'Correlation')
```

### Clustering residual data
```{r decompse.normalise.data2, fig.height=8, fig.width=8, results='asis'}
# Find principal components of expression to plot
PC <- prcomp(RESIDUAL.GENE_EXPRESSION, scale.=T, center = T)

# Plot first 4 PCs
plotdata <- data.frame(SampleID=rownames(PC$rotation), 
                       PC1=PC$rotation[,1], 
                       PC2=PC$rotation[,2])

plotdata <- left_join(plotdata, rownameToFirstColumn(COVARIATES, 'SampleID')) %>%
  tidyr::separate(Dx.Tissue, c('Dx','Tissue'), sep = '_') %>% 
  dplyr::mutate(Institution = "NIMH-HBCC")

p <- ggplot(plotdata, aes(x=PC1, y=PC2))
p <- p + geom_point(aes(color=Institution, shape=Tissue, size=ageOfDeath))
p <- p + theme_bw() + theme(legend.position="right") + facet_grid(Tissue~., scales = 'free_y')
p
```

```{r decompose.normalise.data2.1, fig.height=8, fig.width=12, results='asis'}
# Eucledian tree based analysis
COVARIATES.tmp = data.matrix(COVARIATES[,c('Dx.Tissue'), drop = F])

tree = hclust(as.dist(t(RESIDUAL.GENE_EXPRESSION)))
cols = WGCNA::labels2colors(COVARIATES.tmp);

WGCNA::plotDendroAndColors(tree, 
                           colors = cols, 
                           dendroLabels = FALSE, 
                           abHeight = 0.80, 
                           main = "Sample dendrogram",
                           groupLabels = colnames(COVARIATES.tmp))
```

```{r temp1, include=F}
dev.off()
gc()
```

### Differential expression analysis (SCZ - Control - Other)
Genes that are differentially expressed at an FDR <= 0.05 are:
```{r set-formula}
formula <- glue::glue("~ 0 + ", glue::glue_collapse(adjust.covars, sep = " + ")) %>% 
  glue::glue(" + (1|{random_effect})")
```

`r formula`

```{r diffExp, fig.height=10, fig.width=15}
L1 = variancePartition::getContrast(exprObj = VOOM.GENE_EXPRESSION, 
                                   formula = formula, 
                                   data = COVARIATES, 
                                   coefficient = c("Dx.TissueOther_ACC", "Dx.TissueControl_ACC"))
L2 = variancePartition::getContrast(exprObj = VOOM.GENE_EXPRESSION, 
                                   formula = formula, 
                                   data = COVARIATES, 
                                   coefficient = c("Dx.TissueSCZ_ACC", "Dx.TissueControl_ACC"))
L3 = variancePartition::getContrast(exprObj = VOOM.GENE_EXPRESSION, 
                                   formula = formula, 
                                   data = COVARIATES, 
                                   coefficient = c("Dx.TissueSCZ_ACC", "Dx.TissueOther_ACC"))
L4 = variancePartition::getContrast(exprObj = VOOM.GENE_EXPRESSION, 
                                   formula = formula, 
                                   data = COVARIATES, 
                                   coefficient = c("Dx.TissueOther_STG", "Dx.TissueControl_STG"))
L5 = variancePartition::getContrast(exprObj = VOOM.GENE_EXPRESSION, 
                                   formula = formula, 
                                   data = COVARIATES, 
                                   coefficient = c("Dx.TissueSCZ_STG", "Dx.TissueControl_STG"))
L6 = variancePartition::getContrast(exprObj = VOOM.GENE_EXPRESSION, 
                                   formula = formula, 
                                   data = COVARIATES, 
                                   coefficient = c("Dx.TissueSCZ_STG", "Dx.TissueOther_STG"))


L = cbind(L1, L2, L3, L4, L5, L6)

contrast <- c(glue::glue_collapse(names(L1[L1 != 0]), "-"), 
              glue::glue_collapse(names(L2[L2 != 0]), "-"),
              glue::glue_collapse(names(L3[L3 != 0]), "-"),
              glue::glue_collapse(names(L4[L4 != 0]), "-"),
              glue::glue_collapse(names(L5[L5 != 0]), "-"),
              glue::glue_collapse(names(L6[L6 != 0]), "-")
)

# Visualize contrast matrix
plotContrasts(L) 

# Fit contrast
FIT.CONTR = variancePartition::dream(exprObj = VOOM.GENE_EXPRESSION,
                                     formula = formula,
                                     data = COVARIATES,
                                     L = L)

# Get background genes 
backgroundGenes = data.frame(gene_id = rownames(NEW.COUNTS)) %>%
  dplyr::mutate(id = gene_id) %>%
  tidyr::separate(id, c('ensembl_gene_id','position'), sep = '\\.')

# Get gene lengths
counts = 'syn21867866'
ALL_USED_IDs = counts
counts = downloadFile(counts) %>% data.frame()
gene_lengths = counts[,c("Geneid", "Length")] %>% 
  dplyr::rename(gene_id = Geneid)
rm(counts)

# Define biomart object
mart <- biomaRt::useMart(biomart = "ENSEMBL_MART_ENSEMBL",
                host = "uswest.ensembl.org", # Ensembl Release 99 (January 2020)
                dataset = "hsapiens_gene_ensembl")

# Query biomart
Ensemble2HGNC <- getBM(attributes = c("ensembl_gene_id", "hgnc_symbol", 
                                      "percentage_gene_gc_content", "gene_biotype", 
                                      "chromosome_name"),
                       filters = "ensembl_gene_id", 
                       values = backgroundGenes$ensembl_gene_id,
                       mart = mart)

# Get differential expression
DE = lapply(glue::glue("L{1:6}"), function(i, FIT){
  topTable(FIT, coef=i, number = Inf) %>%
    rownameToFirstColumn('gene_id') %>% 
    left_join(backgroundGenes)
}, FIT.CONTR) 
names(DE) <- contrast

DE = DE %>% 
  rbindlist(idcol = 'Comparison') %>%
  dplyr::mutate(Comparison = gsub('Dx.Tissue','',Comparison),
                Direction = logFC/abs(logFC),
                Direction = factor(Direction, c(-1,1), c('-1' = 'DOWN', '1' = 'UP')),
                Direction = as.character(Direction)) %>%
  tidyr::separate(Comparison, into = c('ref.state','to.state'), sep = '-') %>%
  tidyr::separate(ref.state, into = c('Dx1','Tissue'), sep = '_') %>%
  tidyr::separate(to.state, into = c('Dx2','Tissue'), sep = '_') %>%
  tidyr::unite(Comparison, Dx1, Dx2, sep = '_vs_') %>%
  left_join(Ensemble2HGNC) %>%
  left_join(gene_lengths)
DE$Direction[DE$adj.P.Val > 0.05 | abs(DE$logFC) < log2(1.2)] = 'NONE'

tmp = DE %>%
  dplyr::filter(adj.P.Val <= 0.05) %>%
  dplyr::select(ensembl_gene_id, Comparison, Tissue) %>%
  group_by(Comparison, Tissue) %>%
  dplyr::summarise(FDR_0_05 = length(unique(ensembl_gene_id)))

tmp1 = DE %>%
  dplyr::filter(adj.P.Val <= 0.05, abs(logFC) >= log2(1.2)) %>%
  dplyr::select(ensembl_gene_id, Comparison, Tissue) %>%
  group_by(Comparison, Tissue) %>%
  dplyr::summarise(FDR_0_05_FC_1.2 = length(unique(ensembl_gene_id)))

kable(full_join(tmp,tmp1))

p = ggplot(DE, aes(y = -log10(adj.P.Val), x = logFC, color = Direction)) + geom_point() + xlim(c(-1,1))
p = p + scale_color_manual(values = c('green','grey','red')) + theme_bw() %+replace% theme(legend.position = 'top')
p = p + facet_grid(Tissue+.~Comparison, scales = 'fixed')
p
```

### Associate differential expression results with gc content, gene length and average expression
```{r associate.de, fig.height=10, fig.width=15}
pl = list()
pl[[1]] = ggplot(DE %>% 
                   arrange(match(Direction, c("NONE", "UP", "DOWN"))), aes(x = log10(Length), y = logFC, color = Direction)) + geom_point() 
pl[[1]] = pl[[1]] + geom_smooth(method = 'loess', inherit.aes = FALSE, aes(x = log10(Length), y = logFC))
pl[[1]] = pl[[1]] + facet_grid(Tissue~.) + scale_color_manual(values = c('green','grey','red'))
pl[[1]] = pl[[1]] + theme(legend.position = 'top')

pl[[2]] = ggplot(DE %>% 
                   arrange(match(Direction, c("NONE", "UP", "DOWN"))), aes(x = percentage_gene_gc_content, y = logFC, color = Direction)) + geom_point()
pl[[2]] = pl[[2]] + geom_smooth(method = 'loess', inherit.aes = FALSE, aes(x = percentage_gene_gc_content, y = logFC))
pl[[2]] = pl[[2]] + facet_grid(Tissue~.) + scale_color_manual(values = c('green','grey','red'))
pl[[2]] = pl[[2]] + theme(legend.position = 'top')

pl[[3]] = ggplot(DE %>% 
                    arrange(match(Direction, c("NONE", "UP", "DOWN"))), aes(x = AveExpr, y = logFC, color = Direction)) + geom_point()
pl[[3]] = pl[[3]] + geom_smooth(method = 'loess', inherit.aes = FALSE, aes(x = AveExpr, y = logFC))
pl[[3]] = pl[[3]] + facet_grid(Tissue~.) + scale_color_manual(values = c('green','grey','red'))
pl[[3]] = pl[[3]] + theme(legend.position = 'top')

multiplot(plotlist = pl, cols = 3)
```

### Store files in synapse
```{r synapse.store, include=FALSE, eval=TRUE, cache=FALSE}
# Set annotations
all.annotations = list(
  dataType = 'geneExpression',
  dataSubtype = 'processed',
  assay	 = 'rnaSeq',
  
  tissue	= 'superior temporal gyrus, anterior cingulate cortex', 
  study = 'CMC', 

  species = 'Human',
  consortium	= 'CMC',
   
  analysisType	= "data normalization",
  
  transcriptNormalizationMethod	= 'CQN',
  transcriptQuantificationMethod = 'featureCounts',
  referenceSet = 'GRCh38'
)

# Code
CODE <- Folder(name = "Differential Expression - Tissue", parentId = parentId)
CODE <- synStore(CODE)

# Store residual gene expression for network analysis
RESIDUAL.GENE_EXPRESSION %>%
  rownameToFirstColumn('ensembl_gene_id') %>%
  write.table(file = 'CMC_ACC_STG_Tissue_netResidualExpression.tsv', sep = '\t', row.names=F, quote=F)
nEXP_OBJ = File('CMC_ACC_STG_Tissue_netResidualExpression.tsv', 
                name = 'Tissue Normalised, covariates removed residual expression (for network analysis)', 
                parentId = CODE$properties$id)
nEXP_OBJ = synStore(nEXP_OBJ, used = ALL_USED_IDs, activityName = activityName, 
                    executed = thisFile, activityDescription = activityDescription)
synSetAnnotations(nEXP_OBJ, annotations = all.annotations)

# Store differential expression results
write.table(DE, file = 'CMC_ACC_STG_Tissue_DiffExpression.tsv', sep = '\t', row.names=F, quote=F)
DEXP_OBJ = File('CMC_ACC_STG_Tissue_DiffExpression.tsv', 
                name = 'Differential Expression Results (Tissue)', 
                parentId = CODE$properties$id)
DEXP_OBJ = synStore(DEXP_OBJ, used = ALL_USED_IDs, activityName = activityName, 
                    executed = thisFile, activityDescription = activityDescription)
synSetAnnotations(DEXP_OBJ, annotations = all.annotations)

# Store adjusted fit linear mixed model object as RDS - Tissue
saveRDS(ADJUSTED.FIT, file = 'CMC_ACC_STG_Tissue_dream-output.rds')
ADJ_OBJ = File('CMC_ACC_STG_Tissue_dream-output.rds',
               name = 'Dream Output object - Tissue', 
               parentId = CODE$properties$id)
ADJ_OBJ = synStore(ADJ_OBJ, used = ALL_USED_IDs, activityName = activityName,
                   executed = thisFile, activityDescription = activityDescription)
synSetAnnotations(ADJ_OBJ, annotations = all.annotations)
```
